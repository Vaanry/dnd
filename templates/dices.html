{% extends "main.html" %}

{% block crud_container %}
<title>Броски Кубиков с Характеристиками</title>
<style>
    .dice {
        display: inline-block;
        width: 50px;
        height: 50px;
        background-color: #f0f0f0;
        border: 2px solid #333;
        margin: 10px;
        text-align: center;
        line-height: 50px;
        font-size: 24px;
        font-weight: bold;
        border-radius: 5px;
    }

    .button-container {
        margin-top: 20px;
    }

    .result-container {
        margin-top: 20px;
    }

    .result {
        margin: 5px 0;
    }

    .input-container {
        display: block;
        text-align: left;
        margin-top: 20px;
        margin-bottom: 10px;
    }

    .attribute-container {
        display: flex;
        flex-direction: column;
        max-width: 250px;
        margin-top: 20px;
    }

    .attribute-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
        align-items: center;
        gap: 10px;
    }

    .attribute-label {
        min-width: 150px;
        flex: 1;
        font-weight: bold;
        gap: 10px;
    }

    .attribute-select {
        width: 150px;
        gap: 10px;
        /* Компактный размер */
        text-align: center;
    }
</style>
</head>

<body>
    <h1>Бросок 6 раз по 4 кубика с распределением по характеристикам</h1>
    <div>
        <div id="dice-container" hidden>
            <p>Броски кубиков:</p>
            <!-- Кубики будут отображаться здесь -->
        </div>

        <div class="button-container">
            <button onclick="rollDice()">Бросить кубики</button>
        </div>

        <div class="result-container" id="result-container">
            <!-- Результаты бросков будут отображаться здесь -->
        </div>

        <div class="input-container" id="input-container" style="display:none;">
            <h2>Распределите характеристики:</h2>
            <form action="/character/add_dices/" method="post" id="attribute-form">
                <div class="attribute-container">
                    <div class="attribute-row">
                        <span class="attribute-label">Сила:</span>
                        <select id="strength" class="attribute-select" required></select>
                    </div>
                    <div class="attribute-row">
                        <span class="attribute-label">Ловкость:</span>
                        <select id="dexterity" class="attribute-select" required></select>
                    </div>
                    <div class="attribute-row">
                        <span class="attribute-label">Интеллект:</span>
                        <select id="intelligence" class="attribute-select" required></select>
                    </div>
                    <div class="attribute-row">
                        <span class="attribute-label">Мудрость:</span>
                        <select id="wisdom" class="attribute-select" required></select>
                    </div>
                    <div class="attribute-row">
                        <span class="attribute-label">Харизма:</span>
                        <select id="charisma" class="attribute-select" required></select>
                    </div>
                    <div class="attribute-row">
                        <span class="attribute-label">Телосложение:</span>
                        <select id="constitution" class="attribute-select" required></select>
                    </div>
                </div>

                <button type="submit">Отправить</button>
            </form>
        </div>
    </div>

    <script>
        async function sendAttributes(attributes) {
            try {
                const response = await fetch('/character/add_dices/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(attributes), // Отправляем данные как JSON
                });

                const result = await response.json();
                if (response.ok) {
                    window.location.href = '/character/add_dices';
                } else {
                    alert('Ошибка при отправке данных: ' + result.detail);
                }
            } catch (error) {
                console.error('Ошибка при отправке данных:', error);
            }
        }

        // Функция для генерации случайного числа от 1 до 6
        function rollSingleDie() {
            return Math.floor(Math.random() * 6) + 1;
        }

        // Функция для броска одного набора из 4 кубиков с суммированием 3 наибольших значений
        function rollSingleThrow() {
            let diceValues = [];
            let sum = 0;
            // Генерируем 4 значения
            for (let i = 0; i < 4; i++) {
                const value = rollSingleDie();
                diceValues.push(value);
            }
            // Сортируем и отбрасываем наименьшее значение
            diceValues.sort((a, b) => b - a);  // Сортируем по убыванию
            // Суммируем 3 наибольших
            sum = diceValues[0] + diceValues[1] + diceValues[2];
            return { diceValues, sum };
        }

        // Функция для броска 6 раз
        function rollDice() {
            const allThrows = [];
            const resultContainer = document.getElementById("result-container");
            resultContainer.innerHTML = "";  // Очищаем контейнер результатов

            // Генерируем 6 бросков
            for (let i = 0; i < 6; i++) {
                const { diceValues, sum } = rollSingleThrow();
                allThrows.push({ diceValues, sum });

                // Отображаем каждый бросок
                const throwElement = document.createElement("div");
                throwElement.classList.add("result");
                throwElement.textContent = `Бросок ${i + 1}: ${diceValues.join(", ")} (Сумма 3 наибольших: ${sum})`;
                resultContainer.appendChild(throwElement);
            }

            // Отображаем кубики
            displayDice(allThrows);

            // Показываем форму для распределения характеристик
            showAttributeForm(allThrows);
        }

        // Функция для отображения кубиков на странице
        function displayDice(allThrows) {
            const diceContainer = document.getElementById("dice-container");
            diceContainer.innerHTML = "";  // Очищаем контейнер кубиков

            allThrows.forEach((throwResult, index) => {
                const diceRow = document.createElement("div");
                diceRow.textContent = `Бросок ${index + 1}: ${throwResult.diceValues.join(", ")}`;
                diceContainer.appendChild(diceRow);
            });
        }
        // Массив доступных значений (все выпавшие числа)
        let availableSums = [];
        // Массив выбранных значений
        let selectedSums = [];

        // Функция обновления выпадающих списков
        function updateSelectOptions() {
            document.querySelectorAll('.attribute-select').forEach(select => {
                let currentValue = select.value;
                select.innerHTML = '<option value="">--</option>'; // Очищаем список

                // Подсчёт всех чисел, которые можно выбрать
                let remainingNumbers = [...availableSums];

                // Убираем уже выбранные числа (по одному разу)
                selectedSums.forEach(selected => {
                    let index = remainingNumbers.indexOf(selected);
                    if (index !== -1) {
                        remainingNumbers.splice(index, 1);
                    }
                });

                // Добавляем доступные числа в выпадающий список
                remainingNumbers.forEach(num => {
                    let option = document.createElement('option');
                    option.value = num;
                    option.textContent = num;
                    select.appendChild(option);
                });

                // Восстанавливаем текущее значение, если оно ещё доступно
                if (remainingNumbers.includes(parseInt(currentValue))) {
                    select.value = currentValue;
                }
            });
        }

        // Функция обработки выбора значений
        function handleSelectChange() {
            selectedSums = Array.from(document.querySelectorAll('.attribute-select'))
                .map(select => parseInt(select.value) || null)
                .filter(value => value !== null);

            updateSelectOptions();
        }

        // Функция инициализации списков
        function showAttributeForm(allThrows) {
            document.getElementById("input-container").style.display = "block";
            availableSums = allThrows.map(throwResult => throwResult.sum); // Сохраняем все выпавшие числа

            document.querySelectorAll('.attribute-select').forEach(select => {
                select.addEventListener("change", handleSelectChange);
            });

            updateSelectOptions();
        }

        // Добавляем обработчики для всех селектов
        selectElements.forEach(selectElement => {
            selectElement.addEventListener("change", handleSelectChange);
        });

        form.onsubmit = function (event) {
            event.preventDefault();
            const attributes = {
                strength: parseInt(document.getElementById("strength").value),
                dexterity: parseInt(document.getElementById("dexterity").value),
                intelligence: parseInt(document.getElementById("intelligence").value),
                wisdom: parseInt(document.getElementById("wisdom").value),
                charisma: parseInt(document.getElementById("charisma").value),
                constitution: parseInt(document.getElementById("constitution").value)
            };

            // Проверка, что все суммы распределены
            const selectedSums = Object.values(attributes);
            const allSums = allThrows.map(throwResult => throwResult.sum);
            if (selectedSums.some(sum => !allSums.includes(sum))) {
                alert("Пожалуйста, выберите только суммы, полученные в бросках.");
                return;
            }
            sendAttributes(attributes);
        };
    </script>

</body>

{% endblock %}